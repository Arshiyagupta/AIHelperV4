# üì¶ **SafeTalk MVP ‚Äì Full Database Design**

This schema supports all core backend functionality for SafeTalk's conflict resolution flow between two divorced co-parents, mediated by AI agents. It enables account creation, secure partner linking, private AI chats, AI-generated proposals, resolution logging, and red flag handling.

---

## üßç‚Äç‚ôÇÔ∏è Table: `users`

**Purpose**: Stores each user's account information, including their email, permanent partner code, and reference to their connected co-parent.

| Column              | Type            | Description                                           |
| ------------------- | --------------- | ----------------------------------------------------- |
| `id`                | UUID (PK)       | Unique user identifier                                |
| `auth_id`           | UUID            | Maps to Supabase Auth user ID                         |
| `email`             | Text            | User's email address                                  |
| `name`              | Text            | First name (optional but helpful for UI)              |
| `partner_code`      | Text (unique)   | Permanent partner code used to link to co-parent      |
| `connected_user_id` | UUID (nullable) | References the connected co-parent (FK to `users.id`) |
| `fcm_token`         | Text (nullable) | Firebase Cloud Messaging token for push notifications |
| `created_at`        | Timestamp       | Account creation timestamp                            |

---

## üîó Table: `issues`

**Purpose**: Represents one ongoing or resolved parenting issue between a connected user pair. Only one issue can be active at a time.

| Column         | Type                 | Description                                          |
| -------------- | -------------------- | ---------------------------------------------------- |
| `id`           | UUID (PK)            | Unique issue ID                                      |
| `partner_a_id` | UUID                 | First partner in the issue (FK to `users.id`)        |
| `partner_b_id` | UUID                 | Second partner in the issue (FK to `users.id`)       |
| `status`       | Enum                 | `in_progress`, `proposal_sent`, `resolved`, `halted` |
| `summary`      | Text                 | Auto-generated short summary for display             |
| `red_flagged`  | Boolean              | True if abuse/red flag detected                      |
| `created_at`   | Timestamp            | Issue creation timestamp                             |
| `resolved_at`  | Timestamp (nullable) | When the issue was resolved (if applicable)          |

---

## üí¨ Table: `messages`

**Purpose**: Stores all individual messages sent between a user and their personal AI agent within the context of one issue.

| Column        | Type      | Description                                                     |
| ------------- | --------- | --------------------------------------------------------------- |
| `id`          | UUID (PK) | Unique message ID                                               |
| `issue_id`    | UUID      | Linked issue (FK to `issues.id`)                                |
| `sender_type` | Enum      | Either `user` or `ai`                                           |
| `sender_id`   | UUID      | References the user or AI agent                                 |
| `content`     | Text      | Message content                                                 |
| `is_flagged`  | Boolean   | Whether this message contains high-conflict or abusive language |
| `created_at`  | Timestamp | Time sent                                                       |

---

## üß† Table: `mediator_logs`

**Purpose**: Logs all solution proposals generated by the Mediator AI, including scoring and acceptance status.

| Column           | Type      | Description                                    |
| ---------------- | --------- | ---------------------------------------------- |
| `id`             | UUID (PK) | Unique proposal ID                             |
| `issue_id`       | UUID      | Linked issue (FK to `issues.id`)               |
| `version`        | Integer   | Sequential version number (first = 1, etc.)    |
| `content`        | Text      | Full AI-generated proposed solution            |
| `internal_score` | Float     | Internal score (0.0‚Äì1.0) determining readiness |
| `accepted_by_a`  | Boolean   | True if partner A accepted this version        |
| `accepted_by_b`  | Boolean   | True if partner B accepted this version        |
| `created_at`     | Timestamp | When the proposal was generated                |

---

## üîî Table: `notifications`

**Purpose**: Stores notification events for delivery to users (e.g., new issue created, proposal ready, etc.)

| Column       | Type      | Description                                     |
| ------------ | --------- | ----------------------------------------------- |
| `id`         | UUID (PK) | Unique notification ID                          |
| `user_id`    | UUID      | Recipient user (FK to `users.id`)               |
| `type`       | Enum      | `new_issue`, `proposal_ready`, `issue_resolved` |
| `is_read`    | Boolean   | True if the user has seen the notification      |
| `payload`    | JSONB     | Additional info (e.g., issue ID, snippet text)  |
| `created_at` | Timestamp | Time the notification was triggered             |

---

## üß™ Table: `ai_events` *(Optional for debugging/telemetry)*

**Purpose**: (Optional) Logs all AI processing events, for internal monitoring, audit, or future analytics.

| Column       | Type      | Description                 |
| ------------ | --------- | --------------------------- |
| `id`         | UUID (PK) | Unique event ID             |
| `issue_id`   | UUID      | Related issue               |
| `agent`      | Enum      | `partner_ai`, `mediator_ai` |
| `input`      | Text      | Prompt input                |
| `output`     | Text      | Raw GPT output              |
| `created_at` | Timestamp | Time processed              |

---

# üîê Key Relationships

* `users.connected_user_id` ‚Üí connects two user rows as a partner pair
* `issues.partner_a_id` + `partner_b_id` ‚Üí always drawn from two connected users
* `messages.issue_id` ‚Üí each message belongs to one issue
* `mediator_logs.issue_id` ‚Üí all proposals belong to one issue
* `notifications.user_id` ‚Üí one user per notification

---